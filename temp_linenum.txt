// Manage training history list (load, switch, delete) on the training page
(function () {
  let currentTrainId = null;
  let selectEl = null;
  let deleteBtn = null;

  function notify(message) {
    if (window.trainingLog) {
      window.trainingLog(message);
    } else {
      console.log('[training]', message);
    }
  }

  function getCsrfToken() {
    const input = document.querySelector('#train-form input[name="csrfmiddlewaretoken"]');
    if (input) return input.value;
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : '';
  }

  async function fetchJSON(url, options) {
    const response = await fetch(url, options);
    let data = null;
    try {
      data = await response.json();
    } catch (err) {
      data = null;
    }
    return { ok: response.ok, data };
  }

  function populateSessions(items) {
    if (!selectEl) return null;
    selectEl.innerHTML = '';
    (items || []).forEach(it => {
      const opt = document.createElement('option');
      const modelName = ((it.model_name || '') + '').toUpperCase();
      opt.value = String(it.id);
      opt.textContent = `${it.date} | ${modelName} | ${it.round_count}/${it.max_rounds}`;
      selectEl.appendChild(opt);
    });
    return selectEl;
  }

  function renderAccuracy(rounds, accuracies) {
    if (!window.TrainingProgressChart) return;
    const maxRound = rounds && rounds.length ? Math.max(...rounds) + 1 : 10;
    window.TrainingProgressChart.reset(maxRound);
    (rounds || []).forEach((r, idx) => {
      const acc = accuracies[idx];
      if (acc != null) window.TrainingProgressChart.addAccuracyPoint(r + 1, acc);
    });
  }

  async function loadTrain(trainId) {
    if (!trainId) return;
    try {
      const infoResp = await fetchJSON(`/training/rounds/?train_id=${trainId}`);
      if (!infoResp.data || !infoResp.data.success) return;
      const info = infoResp.data;
      renderAccuracy(info.rounds, info.accuracies);

      const lastIdx = (info.accuracies || [])
        .map((val, idx) => (val != null ? idx : null))
        .filter(val => val != null)
        .pop();
      const roundNo = (lastIdx != null) ? lastIdx : ((info.rounds || []).slice(-1)[0] || 0);

      const confResp = await fetchJSON(`/training/confusion/?train_id=${trainId}&round=${roundNo}`);
      if (confResp.data && confResp.data.success && Array.isArray(confResp.data.confusion)) {
        if (window.renderConfusionMatrix) {
          window.renderConfusionMatrix(
            confResp.data.confusion,
            confResp.data.classes || [],
            confResp.data.support || []
          );
        }
      } else if (window.ConfusionHeatmap) {
        window.ConfusionHeatmap.clear();
      }
    } catch (err) {
      console.warn(err);
    }
  }

  async function refreshSessions(preferredId) {
    const listResp = await fetchJSON('/training/trains/');
    if (!listResp.data || !listResp.data.success) return;

    const items = listResp.data.items || [];
    populateSessions(items);

    if (!items.length) {
      currentTrainId = null;
      if (deleteBtn) deleteBtn.disabled = true;
      if (selectEl) selectEl.disabled = true;
      if (window.TrainingProgressChart) window.TrainingProgressChart.reset(10);
      if (window.TrainingLossChart) window.TrainingLossChart.reset(10);
      if (window.ConfusionHeatmap) window.ConfusionHeatmap.clear();
      notify('Нет сохранённых тренировок');
      return;
    }

    if (selectEl) selectEl.disabled = false;

    const ids = items.map(it => String(it.id));
    const targetId = (preferredId && ids.includes(String(preferredId)))
      ? String(preferredId)
      : ids[0];

    currentTrainId = targetId;
    if (selectEl) selectEl.value = targetId;
    if (deleteBtn) deleteBtn.disabled = false;

    await loadTrain(targetId);
  }

  async function handleDelete() {
    if (!currentTrainId) return;
    if (!confirm(`Удалить тренировку #${currentTrainId}?`)) return;

    const token = getCsrfToken();
    if (!token) {
      notify('CSRF токен не найден');
      return;
    }

    const resp = await fetchJSON('/training/delete/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': token,
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: JSON.stringify({ train_id: currentTrainId }),
    });

    if (resp.data && resp.data.success) {
      notify(`Тренировка #${currentTrainId} удалена`);
      await refreshSessions();
    } else {
      const msg = resp.data?.error || 'Не удалось удалить тренировку';
      notify(msg);
    }
  }

  function bindEvents() {
    if (selectEl) {
      selectEl.addEventListener('change', async (ev) => {
        currentTrainId = ev.target.value || null;
        if (deleteBtn) deleteBtn.disabled = !currentTrainId;
        if (currentTrainId) {
          await loadTrain(currentTrainId);
        }
      });
    }

    if (deleteBtn) {
      deleteBtn.addEventListener('click', handleDelete);
    }
  }

  async function init() {
    selectEl = document.getElementById('train-session-select');
    deleteBtn = document.getElementById('train-delete-btn');
    bindEvents();
    await refreshSessions();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
