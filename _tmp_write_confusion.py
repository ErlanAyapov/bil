# -*- coding: utf-8 -*-
from pathlib import Path
content = """// Unified confusion matrix renderer. Provides window.ConfusionHeatmap for training.js\n(function(){\n  let canvas = null;\n  let ctx = null;\n  let labels = [];\n  let matrix = [];\n  let support = [];\n  const padding = { top: 40, right: 20, bottom: 40, left: 60 };\n  const cellMinSize = 24;\n  const fontMain = \"12px Arial\";\n  const fontSmall = \"11px Arial\";\n\n  function ensureConfusionContainer() {\n    let container = document.getElementById('confusion-container');\n    if (!container) {\n      const host = document.querySelector('.bg-white.rounded.shadow-sm.p-4.flex-grow-1');\n      if (!host) return null;\n      const hr = document.createElement('hr');\n      hr.className = 'my-3';\n      host.appendChild(hr);\n      const title = document.createElement('h6');\n      title.textContent = 'Confusion Matrix (по классам)';\n      title.className = 'text-center';\n      host.appendChild(title);\n      container = document.createElement('div');\n      container.id = 'confusion-container';\n      container.className = 'table-responsive';\n      container.innerHTML = '<table id=\"confusion-table\" class=\"table table-sm table-bordered align-middle\"><thead></thead><tbody></tbody></table>';\n      host.appendChild(container);\n    }\n    return container;\n  }\n\n  function ensureCanvas(){\n    if (!canvas) {\n      canvas = document.getElementById('confusion-heatmap');\n      if (canvas) {\n        if (!canvas.width) canvas.width = canvas.clientWidth || 600;\n        if (!canvas.height) canvas.height = canvas.clientHeight || 300;\n        ctx = canvas.getContext('2d');\n      }\n    }\n    return canvas && ctx;\n  }\n\n  function clone2D(arr2d) {\n    return (arr2d || []).map(row => (row || []).slice());\n  }\n\n  function computeMax(arr2d) {\n    let m = 0;\n    for (const row of arr2d || []) {\n      for (const v of row || []) m = Math.max(m, +v || 0);\n    }\n    return Math.max(m, 1e-6);\n  }\n\n  function formatValue(val) {\n    const num = Number(val);\n    return Number.isFinite(num) ? num.toFixed(3) : '0.000';\n  }\n\n  function colorFor(v, maxVal) {\n    const t = Math.max(0, Math.min(1, v / maxVal));\n    const start = [80, 160, 220];\n    const end = [255, 90, 20];\n    const r = Math.round(start[0] + (end[0] - start[0]) * t);\n    const g = Math.round(start[1] + (end[1] - start[1]) * t);\n    const b = Math.round(start[2] + (end[2] - start[2]) * t);\n    return `rgb(${r},${g},${b})`;\n  }\n\n  function drawHeatmap() {\n    if (!ensureCanvas()) return;\n    const rows = matrix.length;\n    const cols = rows ? matrix[0].length : 0;\n    if (!rows || !cols) {\n      ctx.clearRect(0, 0, canvas.width, canvas.height);\n      ctx.fillStyle = '#666';\n      ctx.font = '14px Arial';\n      ctx.textAlign = 'center';\n      ctx.fillText('Пока нет данных для матрицы', canvas.width / 2, canvas.height / 2);\n      return;\n    }\n\n    const maxVal = computeMax(matrix);\n    const W = canvas.width = canvas.clientWidth || canvas.width;\n    const H = canvas.height;\n    const cellW = Math.max(1, Math.floor((W - padding.left - padding.right) / cols));\n    const cellH = Math.max(1, Math.floor((H - padding.top - padding.bottom - 40) / rows));\n    const gridW = cellW * cols;\n    const gridH = cellH * rows;\n    const x0 = padding.left + ( (W - padding.left - padding.right) - gridW ) / 2;\n    const y0 = padding.top + ( (H - padding.top - padding.bottom - 40) - gridH ) / 2;\n\n    ctx.clearRect(0, 0, W, H);\n    ctx.fillStyle = '#222';\n    ctx.font = 'bold 14px Arial';\n    ctx.textAlign = 'center';\n    ctx.fillText('Confusion Matrix', W / 2, 20);\n\n    ctx.textAlign = 'center';\n    ctx.textBaseline = 'middle';\n    ctx.font = fontMain;\n    for (let i = 0; i < rows; i++) {\n      for (let j = 0; j < cols; j++) {\n        const v = +((matrix[i] && matrix[i][j]) || 0);\n        const x = x0 + j * cellW;\n        const y = y0 + i * cellH;\n        ctx.fillStyle = colorFor(v, maxVal);\n        ctx.fillRect(x, y, cellW, cellH);\n        ctx.strokeStyle = 'rgba(0,0,0,0.08)';\n        ctx.strokeRect(x, y, cellW, cellH);\n        ctx.fillStyle = v / maxVal > 0.45 ? '#fff' : '#111';\n        ctx.fillText(formatValue(v), x + cellW / 2, y + cellH / 2);\n      }\n    }\n\n    ctx.fillStyle = '#444';\n    ctx.font = 'bold 12px Arial';\n    ctx.fillText('Predicted', x0 + gridW / 2, y0 - 10);\n    ctx.save();\n    ctx.translate(x0 - 40, y0 + gridH / 2);\n    ctx.rotate(-Math.PI / 2);\n    ctx.fillText('True', 0, 0);\n    ctx.restore();\n\n    ctx.fillStyle = '#333';\n    ctx.font = fontSmall;\n    ctx.textAlign = 'right';\n    for (let i = 0; i < rows; i++) {\n      const y = y0 + i * cellH + cellH / 2;\n      ctx.fillText(labels[i] != null ? String(labels[i]) : String(i), x0 - 8, y);\n    }\n    ctx.textAlign = 'center';\n    for (let j = 0; j < cols; j++) {\n      const x = x0 + j * cellW + cellW / 2;\n      ctx.save();\n      ctx.translate(x, y0 + gridH + 14);\n      ctx.rotate(-Math.PI / 4);\n      ctx.fillText(labels[j] != null ? String(labels[j]) : String(j), 0, 0);\n      ctx.restore();\n    }\n  }\n\n  function renderTable() {\n    const container = ensureConfusionContainer();\n    if (!container) return;\n    const table = container.querySelector('#confusion-table');\n    if (!table) return;\n    const thead = table.querySelector('thead');\n    const tbody = table.querySelector('tbody');\n    const cls = (Array.isArray(labels) && labels.length)\n      ? labels\n      : (Array.isArray(matrix) && matrix[0] ? matrix[0].map((_, i) => i) : []);\n\n    let headHtml = '<tr><th></th>' + cls.map(c => `<th class=\"text-center\">${c}</th>`).join('') + '<th class=\"text-center\">Σ</th></tr>';\n    thead.innerHTML = headHtml;\n\n    if (!matrix.length) {\n      tbody.innerHTML = '<tr><td colspan=\"100%\" class=\"text-center text-muted\">Нет данных</td></tr>';\n      return;\n    }\n\n    let bodyHtml = '';\n    for (let i = 0; i < matrix.length; i++) {\n      const row = matrix[i] || [];\n      const sum = row.reduce((a,b)=>a+Number(b||0),0);\n      bodyHtml += `<tr><th class=\"text-center\">${cls[i] ?? i}</th>` +\n        row.map(v => `<td class=\"text-end\">${formatValue(v)}</td>`).join('') +\n        `<td class=\"text-end fw-semibold\">${formatValue(sum)}</td></tr>`;\n    }\n    if (Array.isArray(support) && support.length) {\n      const total = support.reduce((a,b)=>a+Number(b||0),0);\n      bodyHtml += '<tr><th>support</th>' + support.map(v => `<td class=\"text-end\">${formatValue(v)}</td>`).join('') + `<td class=\"text-end fw-semibold\">${formatValue(total)}</td></tr>`;\n    }\n    tbody.innerHTML = bodyHtml;\n  }\n\n  function render() {\n    drawHeatmap();\n    renderTable();\n  }\n\n  const api = {\n    init(initLabels = [], initMatrix = [], initSupport = []) {\n      labels = Array.isArray(initLabels) ? [...initLabels] : [];\n      matrix = clone2D(initMatrix);\n      support = Array.isArray(initSupport) ? [...initSupport] : [];\n      render();\n    },\n    setLabels(newLabels = []) {\n      labels = Array.isArray(newLabels) ? [...newLabels] : [];\n      render();\n    },\n    setMatrix(newMatrix = []) {\n      matrix = clone2D(newMatrix);\n      render();\n    },\n    setSupport(newSupport = []) {\n      support = Array.isArray(newSupport) ? [...newSupport] : [];\n      render();\n    },\n    updateCell(i, j, value) {\n      if (Array.isArray(matrix[i])) {\n        matrix[i][j] = value;\n        render();\n      }\n    },\n    clear() {\n      labels = [];\n      matrix = [];\n      support = [];\n      if (ctx && canvas) ctx.clearRect(0, 0, canvas.width, canvas.height);\n      const container = document.getElementById('confusion-container');\n      const tbody = container?.querySelector('#confusion-table tbody');\n      if (tbody) tbody.innerHTML = '<tr><td colspan=\"100%\" class=\"text-center text-muted\">Нет данных</td></tr>';\n    }\n  };\n\n  function handleMessage(msg) {\n    if (!msg) return;\n    if (msg.type === 'global_weights' && Array.isArray(msg.confusion)) {\n      api.setLabels(msg.classes || []);\n      api.setMatrix(msg.confusion);\n      api.setSupport(msg.support || []);\n    } else if (msg.type === 'confusion_matrix' and Array.isArray(msg.matrix)) {\n      api.setLabels(msg.labels || []);\n      api.setMatrix(msg.matrix);\n      if (Array.isArray(msg.support)) api.setSupport(msg.support);\n    } else if (msg.type === 'training_complete' and Array.isArray(msg.matrix)) {\n      api.setLabels(msg.labels || []);\n      api.setMatrix(msg.matrix);\n      if (Array.isArray(msg.support)) api.setSupport(msg.support);\n    }\n  }\n\n  function hook() {\n    if (!window.wsUi) return;\n    const prev = wsUi.onmessage;\n    wsUi.onmessage = function(ev) {\n      if (typeof prev === 'function') {\n        try { prev.call(wsUi, ev); } catch (e) { /* noop */ }\n      }\n      try {\n        const msg = JSON.parse(ev.data);\n        handleMessage(msg);\n      } catch (e) { /* noop */ }\n    };\n  }\n\n  window.ConfusionHeatmap = api;\n  window.renderConfusionMatrix = (matrix, classes = [], supportData = []) => {\n    api.setLabels(classes || []);\n    api.setMatrix(matrix || []);\n    api.setSupport(supportData || []);\n  };\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', hook);\n  } else {\n    hook();\n  }\n})();\n"""
Path('main/static/main/scripts/training_confusion.js').write_text(content, encoding='utf-8')
